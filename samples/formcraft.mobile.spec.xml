<?xml version="1.0" encoding="UTF-8"?>
<!--
  FormCraft - Mobile Application Spec

  Uses mobile-native patterns:
  - Tab navigation (bottom tabs)
  - Push navigation with back buttons
  - Bottom sheets instead of modals
  - Swipe actions on list items
  - Pull-to-refresh
  - Floating action buttons
-->
<mobileapp name="FormCraft" version="1.0">

  <import src="./formcraft.shared.spec.xml" />


  <!-- ==================== GUARDS ==================== -->
  <guards>
    <guard name="auth" prompt="if not authenticated, redirect to @screen.Login" />
  </guards>


  <!-- ==================== ACTIONS ==================== -->
  <actions>
    <action name="refresh" prompt="refresh list data" />
    <action name="create" prompt="submit form, dismiss sheet, show success toast" />
    <action name="delete" prompt="show confirm alert, delete item, refresh list" />
    <action name="share" prompt="open system share sheet" />
    <action name="search" prompt="filter list by query" />
    <action name="publish" prompt="publish form, show success toast" />
  </actions>


  <!-- ==================== TAB NAVIGATION ==================== -->
  <container type="tabs">
    <element prompt="home icon, screen @screen.FormList">Forms</element>
    <element prompt="inbox icon, screen @screen.Submissions, badge @state.unreadCount">Inbox</element>
    <element prompt="bar-chart icon, screen @screen.Analytics">Analytics</element>
    <element prompt="user icon, screen @screen.Profile">Profile</element>
  </container>


  <!-- ==================== SCREENS ==================== -->
  <screens>

    <!-- Form List Screen -->
    <screen name="FormList" prompt="initial">
      <data>
        <query name="forms" type="@entity.Form[]" prompt="filter owner == @auth.user, order by updatedAt desc" />
      </data>

      <container type="column" prompt="safe area">
        <container type="row" prompt="padding medium, justify between, align center">
          <element type="text" prompt="large title">Forms</element>
          <element type="button" prompt="plus icon, style primary, on tap present @sheet.CreateForm" />
        </container>

        <element type="search" prompt="placeholder Search forms..., on search @action.search, padding medium" />

        <container type="row" prompt="segmented control, padding medium">
          <element prompt="value all">All</element>
          <element prompt="value published">Published</element>
          <element prompt="value draft">Drafts</element>
        </container>

        <container type="list" prompt="pull to refresh @action.refresh" for-each="@state.forms">
          <element type="@component.FormCard" prompt="swipe actions, on tap push @screen.FormDetail with id @item.id">
            <element prompt="swipe right, share icon, style primary, on tap present @sheet.ShareForm with id @item.id" />
            <element prompt="swipe right, copy icon, on tap @action.duplicate" />
            <element prompt="swipe right, trash icon, style danger, on tap @action.delete" />
          </element>
        </container>

        <element type="@component.EmptyState" if-not="@state.forms.length" prompt="
          title No forms yet,
          description Create your first form to get started,
          actionLabel Create Form,
          on action present @sheet.CreateForm
        " />
      </container>
    </screen>


    <!-- Form Detail Screen -->
    <screen name="FormDetail" prompt="param id">
      <data>
        <query name="form" type="@entity.Form" prompt="filter id == @param.id, include fields, submissions" />
      </data>

      <element type="nav-bar" prompt="title @state.form.name, back button">
        <element prompt="right, edit icon, on tap push @screen.FormEditor with id @param.id" />
        <element prompt="right, more icon, on tap present @sheet.FormActions" />
      </element>

      <container type="column" prompt="padding medium, gap large">
        <!-- Stats -->
        <container type="scroll" prompt="horizontal, gap medium">
          <element type="@component.StatCard" prompt="label Fields, value @state.form.fields.length, compact" />
          <element type="@component.StatCard" prompt="label Responses, value @state.form.submissions.length, compact" />
          <element type="@component.StatCard" prompt="label Views, value @state.form.viewCount, compact" />
        </container>

        <!-- Status & Actions -->
        <container type="card" prompt="padding medium">
          <container type="row" prompt="justify between, align center">
            <container type="column" prompt="gap extra-small">
              <element type="text" prompt="caption, muted">Status</element>
              <element type="badge" use="@state.form.status" prompt="size large" />
            </container>
            <element type="button" prompt="style outline, share icon, on tap present @sheet.ShareForm" if="@state.form.status == 'published'">Share</element>
            <element type="button" prompt="style primary, on tap @action.publish" if-not="@state.form.status == 'published'">Publish</element>
          </container>
        </container>

        <!-- Recent Submissions -->
        <container type="column">
          <container type="row" prompt="justify between, align center, margin bottom small">
            <element type="text" prompt="headline">Recent Responses</element>
            <element type="button" prompt="style text, on tap push @screen.FormSubmissions with id @param.id">View All</element>
          </container>

          <container type="card">
            <container for-each="@state.form.submissions | limit(5)">
              <element type="@component.SubmissionRow" prompt="on tap present @sheet.SubmissionDetail with id @item.id" />
            </container>
            <element type="@component.EmptyState" if-not="@state.form.submissions.length" prompt="
              icon inbox,
              title No responses yet,
              description Share your form to start collecting responses
            " />
          </container>
        </container>
      </container>
    </screen>


    <!-- Form Editor Screen -->
    <screen name="FormEditor" prompt="param id">
      <data>
        <query name="form" type="@entity.Form" prompt="filter id == @param.id, include fields, settings" />
      </data>

      <element type="nav-bar" prompt="title Edit Form, back button">
        <element prompt="right, label Save, on tap @action.save, disabled if-not @state.isDirty" />
      </element>

      <container type="column">
        <!-- Form Name -->
        <container prompt="padding medium, background white, border bottom">
          <element type="input" prompt="variant ghost, size large, placeholder Form Title" use="@state.form.name" />
        </container>

        <!-- Fields List -->
        <container type="list" prompt="reorderable, on reorder @action.reorderFields" for-each="@state.form.fields">
          <container prompt="padding medium, background white, border bottom, interactive, on tap present @sheet.EditField with id @item.id">
            <container type="row" prompt="gap medium, align center">
              <element type="icon" prompt="grip-vertical, muted" />
              <container type="column" prompt="grow, gap extra-small">
                <container type="row" prompt="gap small, align center">
                  <element type="text" prompt="body, weight medium" use="@item.label" />
                  <element type="text" prompt="color danger" if="@item.required">*</element>
                </container>
                <element type="text" prompt="caption, muted" use="@item.type" />
              </container>
              <element type="icon" prompt="chevron-right, muted" />
            </container>
          </container>
        </container>

        <!-- Add Field Button -->
        <container prompt="padding medium">
          <element type="button" prompt="style outline, full width, plus icon, on tap present @sheet.AddField">Add Field</element>
        </container>
      </container>
    </screen>


    <!-- Submissions Screen (Inbox) -->
    <screen name="Submissions">
      <data>
        <query name="submissions" type="@entity.Submission[]" prompt="filter form.owner == @auth.user, order by createdAt desc" />
      </data>

      <container type="column" prompt="safe area">
        <element type="text" prompt="large title, padding medium">Inbox</element>

        <container type="row" prompt="segmented control, padding medium">
          <element prompt="value unread, badge @state.unreadCount">Unread</element>
          <element prompt="value all">All</element>
          <element prompt="value spam">Spam</element>
        </container>

        <container type="list" prompt="pull to refresh, grouped, group by form.name" for-each="@state.submissions">
          <element type="@component.SubmissionRow" prompt="swipe actions, on tap present @sheet.SubmissionDetail with id @item.id">
            <element prompt="swipe left, check icon, style success, on tap @action.markAsRead" />
            <element prompt="swipe right, trash icon, style danger, on tap @action.delete" />
            <element prompt="swipe right, alert-triangle icon, on tap @action.markAsSpam" />
          </element>
        </container>
      </container>
    </screen>


    <!-- Analytics Screen -->
    <screen name="Analytics">
      <data>
        <query name="stats" prompt="source api/analytics/overview" />
      </data>

      <container type="column" prompt="safe area">
        <element type="text" prompt="large title, padding medium">Analytics</element>

        <container type="scroll">
          <container type="column" prompt="padding medium, gap large">
            <!-- Period Selector -->
            <container type="row" prompt="segmented control">
              <element prompt="value 7d">7 Days</element>
              <element prompt="value 30d">30 Days</element>
              <element prompt="value 90d">90 Days</element>
            </container>

            <!-- Stats Grid -->
            <container type="grid" prompt="2 columns, gap medium">
              <element type="@component.StatCard" prompt="label Submissions, value @state.stats.submissions, trend @state.stats.submissionsTrend" />
              <element type="@component.StatCard" prompt="label Completion Rate, value @state.stats.completionRate, format percent" />
              <element type="@component.StatCard" prompt="label Avg Time, value @state.stats.avgTime, format duration" />
              <element type="@component.StatCard" prompt="label Views, value @state.stats.views" />
            </container>

            <!-- Submissions Chart -->
            <container type="card" prompt="padding medium">
              <element type="text" prompt="headline, margin bottom medium">Submissions Over Time</element>
              <prompt>
                Line chart showing submissions per day for the selected period.
                Interactive with touch to see daily values.
              </prompt>
            </container>

            <!-- Top Forms -->
            <container type="card" prompt="padding medium">
              <element type="text" prompt="headline, margin bottom medium">Top Forms</element>
              <container for-each="@state.stats.topForms">
                <container type="row" prompt="padding small, gap medium, align center">
                  <element type="text" prompt="grow" use="@item.name" />
                  <element type="text" prompt="body, weight medium" use="@item.submissions" />
                </container>
              </container>
            </container>
          </container>
        </container>
      </container>
    </screen>


    <!-- Profile Screen -->
    <screen name="Profile">
      <data>
        <query name="user" prompt="source auth.currentUser" />
      </data>

      <container type="column" prompt="safe area">
        <container type="column" prompt="align center, padding extra-large, gap medium">
          <element type="@component.Avatar" prompt="src @state.user.avatar, name @state.user.name, size extra-large" />
          <element type="text" prompt="title" use="@state.user.name" />
          <element type="text" prompt="body, muted" use="@state.user.email" />
          <element type="badge" use="@state.user.plan" prompt="size large" />
        </container>

        <container type="list" prompt="grouped">
          <container prompt="section Account">
            <container prompt="user icon, chevron, on tap push @screen.EditProfile">Edit Profile</container>
            <container prompt="key icon, chevron, on tap push @screen.ApiKeys">API Keys</container>
            <container prompt="bell icon, chevron, on tap push @screen.NotificationSettings">Notifications</container>
          </container>

          <container prompt="section Subscription">
            <container prompt="credit-card icon, chevron, on tap push @screen.Billing">Billing</container>
            <container prompt="zap icon, chevron, style primary, on tap push @screen.Upgrade" if="@state.user.plan == 'free'">Upgrade to Pro</container>
          </container>

          <container prompt="section Support">
            <container prompt="help-circle icon, chevron, on tap @action.openHelp">Help Center</container>
            <container prompt="message-circle icon, chevron, on tap @action.openChat">Contact Us</container>
          </container>

          <container prompt="section">
            <container prompt="log-out icon, style danger, on tap @action.logout">Sign Out</container>
          </container>
        </container>
      </container>
    </screen>


    <!-- Settings Screens -->
    <screen name="EditProfile">
      <element type="nav-bar" prompt="title Edit Profile, back button" />
      <prompt>
        Profile edit form with:
        - Avatar upload (tap to change)
        - Name field
        - Email field (read-only with change option)
        - Save button
      </prompt>
    </screen>

    <screen name="ApiKeys">
      <element type="nav-bar" prompt="title API Keys, back button" />
      <prompt>
        API keys management with:
        - List of existing keys (name, last used, permissions)
        - Swipe to delete
        - FAB to create new key
        - Tap to copy key
      </prompt>
    </screen>

    <screen name="Billing">
      <element type="nav-bar" prompt="title Billing, back button" />
      <prompt>
        Billing screen with:
        - Current plan card
        - Usage stats (forms, submissions, storage)
        - Payment method
        - Billing history list
      </prompt>
    </screen>

  </screens>


  <!-- ==================== SHEETS ==================== -->
  <sheets>

    <!-- Create Form Sheet -->
    <sheet name="CreateForm" prompt="height auto, dismissible">
      <container type="column" prompt="padding large, gap medium">
        <container type="row" prompt="justify between, align center">
          <element type="text" prompt="headline">New Form</element>
          <element type="button" prompt="x icon, style ghost, on tap dismiss sheet" />
        </container>

        <container type="form" prompt="on submit @action.create, on success dismiss sheet then push @screen.FormEditor with id @result.id">
          <container type="column" prompt="gap medium">
            <element type="input" prompt="required, placeholder e.g. Contact Form">Form Name</element>
            <element type="textarea" prompt="rows 2, placeholder Optional description...">Description</element>
            <element type="button" prompt="full width, style primary, type submit">Create Form</element>
          </container>
        </container>

        <element type="separator" prompt="label or start from template" />

        <container type="scroll" prompt="horizontal, gap small" for-each="@state.templates">
          <container type="card" prompt="padding small, width 120px, interactive, on tap @action.createFromTemplate with id @item.id">
            <container type="column" prompt="align center, gap extra-small">
              <element type="icon" use="@item.icon" prompt="size large, color primary" />
              <element type="text" prompt="caption, align center" use="@item.name" />
            </container>
          </container>
        </container>
      </container>
    </sheet>


    <!-- Share Form Sheet -->
    <sheet name="ShareForm" prompt="height auto, dismissible, param id">
      <data>
        <query name="form" type="@entity.Form" prompt="filter id == @param.id" />
      </data>

      <container type="column" prompt="padding large, gap medium">
        <element type="text" prompt="headline">Share Form</element>

        <!-- Link -->
        <container type="card" prompt="padding medium">
          <container type="row" prompt="gap medium, align center">
            <container type="column" prompt="grow">
              <element type="text" prompt="caption, muted">Form Link</element>
              <element type="text" prompt="body" use="@state.form.publicUrl" />
            </container>
            <element type="button" prompt="copy icon, style ghost, on tap @action.copyLink" />
          </container>
        </container>

        <!-- QR Code -->
        <container prompt="align center, padding medium">
          <prompt>QR code for the form URL, 150x150px</prompt>
        </container>

        <!-- Share Options -->
        <container type="row" prompt="gap medium, justify center">
          <element type="button" prompt="message-circle icon, style outline, on tap @action.shareVia with method sms">SMS</element>
          <element type="button" prompt="mail icon, style outline, on tap @action.shareVia with method email">Email</element>
          <element type="button" prompt="share icon, style outline, on tap @action.shareNative">More</element>
        </container>
      </container>
    </sheet>


    <!-- Add Field Sheet -->
    <sheet name="AddField" prompt="height large, dismissible">
      <container type="column">
        <container type="row" prompt="padding medium, justify between, align center, border bottom">
          <element type="text" prompt="headline">Add Field</element>
          <element type="button" prompt="x icon, style ghost, on tap dismiss sheet" />
        </container>

        <container type="list" prompt="grouped">
          <container prompt="section Basic">
            <container prompt="type icon, on tap @action.addField with type text then dismiss sheet">Text</container>
            <container prompt="mail icon, on tap @action.addField with type email then dismiss sheet">Email</container>
            <container prompt="hash icon, on tap @action.addField with type number then dismiss sheet">Number</container>
            <container prompt="phone icon, on tap @action.addField with type phone then dismiss sheet">Phone</container>
            <container prompt="align-left icon, on tap @action.addField with type textarea then dismiss sheet">Long Text</container>
          </container>

          <container prompt="section Choice">
            <container prompt="chevron-down icon, on tap @action.addField with type select then dismiss sheet">Dropdown</container>
            <container prompt="circle icon, on tap @action.addField with type radio then dismiss sheet">Radio</container>
            <container prompt="check-square icon, on tap @action.addField with type checkbox then dismiss sheet">Checkbox</container>
          </container>

          <container prompt="section Advanced">
            <container prompt="calendar icon, on tap @action.addField with type date then dismiss sheet">Date</container>
            <container prompt="clock icon, on tap @action.addField with type time then dismiss sheet">Time</container>
            <container prompt="upload icon, on tap @action.addField with type file then dismiss sheet">File Upload</container>
            <container prompt="star icon, on tap @action.addField with type rating then dismiss sheet">Rating</container>
            <container prompt="pen-tool icon, on tap @action.addField with type signature then dismiss sheet">Signature</container>
          </container>
        </container>
      </container>
    </sheet>


    <!-- Edit Field Sheet -->
    <sheet name="EditField" prompt="height large, dismissible, param id">
      <prompt>
        Field editor sheet with:
        - Label input
        - Placeholder input
        - Help text input
        - Required toggle
        - Field-type specific options (e.g., choices for select/radio)
        - Delete button at bottom
        - Save button in header
      </prompt>
    </sheet>


    <!-- Submission Detail Sheet -->
    <sheet name="SubmissionDetail" prompt="height large, dismissible, param id">
      <data>
        <query name="submission" type="@entity.Submission" prompt="filter id == @param.id, include form" />
      </data>

      <container type="column">
        <container type="row" prompt="padding medium, justify between, align center, border bottom">
          <container type="column">
            <element type="text" prompt="headline" use="@state.submission.form.name" />
            <element type="text" prompt="caption, muted, format datetime" use="@state.submission.createdAt" />
          </container>
          <element type="button" prompt="x icon, style ghost, on tap dismiss sheet" />
        </container>

        <container type="scroll" prompt="padding medium">
          <container type="column" prompt="gap medium" for-each="@state.submission.form.fields">
            <container>
              <element type="text" prompt="caption, muted" use="@item.label" />
              <element type="text" prompt="body" use="@state.submission.data[@item.id]" />
            </container>
          </container>
        </container>

        <container prompt="padding medium, border top">
          <container type="row" prompt="gap medium">
            <element type="button" prompt="style outline, grow, trash icon, style danger, on tap @action.delete">Delete</element>
            <element type="button" prompt="style outline, grow, alert-triangle icon, on tap @action.markAsSpam">Spam</element>
          </container>
        </container>
      </container>
    </sheet>

  </sheets>


  <!-- ==================== ALERTS ==================== -->
  <!-- Alert children use type inference: text for message, actions implied -->
  <alerts>
    <alert name="ConfirmDelete" prompt="title Delete Form?, style destructive">
      <element>This will permanently delete the form and all its submissions. This action cannot be undone.</element>
      <element prompt="role cancel">Cancel</element>
      <element prompt="role destructive, on tap @callback">Delete</element>
    </alert>

    <alert name="ConfirmPublish" prompt="title Publish Form?">
      <element>Your form will be publicly accessible. You can unpublish it at any time.</element>
      <element prompt="role cancel">Cancel</element>
      <element prompt="role default, on tap @callback">Publish</element>
    </alert>
  </alerts>

</mobileapp>
